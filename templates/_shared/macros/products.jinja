{% macro money(amount, currency='USD') -%}
  {%- if amount is none or amount is undefined -%}
    -
  {%- else -%}
    {%- set currency = currency | default('USD', true) -%}
    {%- if amount is number -%}
      {%- set formatted = amount | float %}
    {%- else -%}
      {%- set formatted = amount %}
    {%- endif -%}
    {%- if currency == 'USD' -%}
      ${{ formatted }}
    {%- else -%}
      {{ currency }} {{ formatted }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{% macro badges(items) -%}
  {%- if items -%}
    <ul class="badge-list">
      {%- for badge in items %}
        {%- set label = badge %}
        {%- if badge is mapping -%}
          {%- set label = badge.label
            or badge.name
            or badge.title
            or badge.slug
            or badge.id -%}
        {%- endif -%}
        {%- set label_text = label | default('', true) | string -%}
        {%- if label_text %}
          <li class="badge badge--{{ label_text | replace(' ', '-') | lower }}">{{ label_text }}</li>
        {%- endif %}
      {%- endfor %}
    </ul>
  {%- endif -%}
{%- endmacro %}

{% macro card(product) -%}
  {%- set title = product.title
    or product.name
    or product.product_name
    or product.quickDescription
    or 'Untitled product' -%}
  {%- set slug = product.slug or product.handle or product.id -%}

  {%- set price_obj = product.price if product.price is defined else none -%}
  {%- if price_obj is mapping -%}
    {%- set amount = price_obj.amount
      or price_obj.value
      or price_obj.price
      or price_obj.amountCents
      or price_obj.amount_cents -%}
    {%- set currency = price_obj.currency
      or price_obj.currencyCode
      or price_obj.currency_code
      or 'USD' -%}
  {%- else -%}
    {%- set amount = price_obj %}
    {%- set currency = product.currency
      or product.currency_code
      or 'USD' -%}
  {%- endif -%}

  {%- set images = product.images | default([], true) -%}
  {%- set primary_image = product.image
    or (images | first) -%}
  {%- if primary_image is mapping -%}
    {%- set image_src = primary_image.src
      or primary_image.url
      or primary_image.fullPath
      or primary_image.full_path
      or primary_image.path -%}
    {%- set image_alt = primary_image.alt
      or primary_image.title
      or primary_image.description
      or title -%}
  {%- else -%}
    {%- set image_src = primary_image %}
    {%- set image_alt = title -%}
  {%- endif -%}

  {%- set description = product.snippet
    or product.quickDescription
    or product.description
    or product.quickSpecifications
    or '' -%}

  <article class="product-card">
    {%- if image_src %}
    <div class="product-card__image">
      <img src="{{ image_src }}" alt="{{ image_alt }}" />
    </div>
    {%- endif %}
    <div class="product-card__body">
      <h3>
        {%- if slug -%}
          <a href="/@{{ site.slug }}/products/{{ slug }}">{{ title }}</a>
        {%- else -%}
          {{ title }}
        {%- endif -%}
      </h3>
      {%- if description %}
      {%- set excerpt = description %}
      {%- if description is string and description | length > 160 %}
        {%- set excerpt = description[:160] ~ 'â€¦' -%}
      {%- endif %}
      <p>{{ excerpt }}</p>
      {%- endif %}
      <p class="product-card__price">
        {{ money(amount, currency) }}
      </p>
    </div>
  </article>
{%- endmacro %}

{% macro grid(products) -%}
  {%- if products is mapping and products.items is defined -%}
    {%- set items = products.items -%}
  {%- else -%}
    {%- set items = products -%}
  {%- endif -%}
  <div class="product-grid">
    {%- for product in items %}
      {{ card(product) }}
    {%- else %}
      <p class="product-grid__empty">No products available yet.</p>
    {%- endfor %}
  </div>
{%- endmacro %}
